{"version":3,"sources":["lib_draw_graph/clustered.cljc"],"mappings":"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","names":["lib-draw-graph.clustered/->keyword","k","cljs.core/Keyword","cljs.core.keyword.cljs$core$IFn$_invoke$arity$1","lib-draw-graph.clustered/add-cluster-key","g","cluster-on","cljs.core/assoc-in","lib-draw-graph.clustered/cluster-key","cljs.core.get_in.cljs$core$IFn$_invoke$arity$2","lib-draw-graph.clustered/clustered?","lib-draw-graph.clustered/add-attr-to-cluster","cluster","attr-k","attr-v","lib-draw-graph.clustered/add-cluster-edge","src","tgt","cljs.core.update_in.cljs$core$IFn$_invoke$arity$4","old","G__35627","cljs.core._EQ_.cljs$core$IFn$_invoke$arity$2","loom.graph.digraph.cljs$core$IFn$_invoke$arity$variadic","loom.graph.add_edges.cljs$core$IFn$_invoke$arity$variadic","lib-draw-graph.clustered/remove-clusters-from-edge-graph","clstrs","cljs.core.apply.cljs$core$IFn$_invoke$arity$3","loom.graph/remove-nodes","lib-draw-graph.clustered/delete-edge-graph","cljs.core.assoc.cljs$core$IFn$_invoke$arity$3","cljs.core.dissoc.cljs$core$IFn$_invoke$arity$2","lib-draw-graph.clustered/edge-graph","lib-draw-graph.clustered/add-cluster-parent","parent","cljs.core.update_in.cljs$core$IFn$_invoke$arity$3","cljs.core.conj.cljs$core$IFn$_invoke$arity$2","lib-draw-graph.clustered/cluster-parent","lib-draw-graph.clustered/cluster-children","lib-draw-graph.clustered/cluster-graph","lib-draw-graph.clustered/cluster-siblings","chdrn","cljs.core.remove.cljs$core$IFn$_invoke$arity$2","lib-draw-graph.clustered/cluster-descendants","clstr","acc","children","p1__35638#","cljs.core.map.cljs$core$IFn$_invoke$arity$2","descend","cljs.core/flatten","lib-draw-graph.clustered/first-cluster-attr","sub-key","attr","G__35645","cljs.core.get.cljs$core$IFn$_invoke$arity$2","temp__5718__auto__","lib-draw-graph.clustered/merged-cluster-attr","cljs.core.merge.cljs$core$IFn$_invoke$arity$variadic","G__35650","G__35651","var_args","G__35654","lib-draw-graph.clustered/cluster->nodes","js/Error","lib_draw_graph.clustered.cluster__GT_nodes.cljs$core$IFn$_invoke$arity$3","p1__35652#","cljs.core.filter.cljs$core$IFn$_invoke$arity$2","loom.graph/nodes","G__35657","lib-draw-graph.clustered/cluster->all-nodes","lib_draw_graph.clustered.cluster__GT_all_nodes.cljs$core$IFn$_invoke$arity$2","chds","cur-nodes","p1__35655#","res","cljs.core.distinct.cljs$core$IFn$_invoke$arity$1","cljs.core/empty?","G__35665","lib-draw-graph.clustered/nodes-by-cluster","lib_draw_graph.clustered.nodes_by_cluster.cljs$core$IFn$_invoke$arity$2","cljs.core/group-by","G__35669","lib-draw-graph.clustered/node->clusters","n","lib_draw_graph.clustered.node__GT_clusters.cljs$core$IFn$_invoke$arity$3","new-ancestor","cljs.core/first","ancestor","cljs.core/cons","cljs.core.into.cljs$core$IFn$_invoke$arity$2","lib-draw-graph.clustered/nodes->clusters","nds","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","clojure.set/union","p1__35674#","lib_draw_graph.clustered.node__GT_clusters.cljs$core$IFn$_invoke$arity$2","lib-draw-graph.clustered/clusters","lib-draw-graph.clustered/filter->parent","m","set-to-remove","cljs.core.reduce.cljs$core$IFn$_invoke$arity$3","p__35681","vec__35682","cljs.core.nth.cljs$core$IFn$_invoke$arity$3","a","v","cljs.core/some","lib-draw-graph.clustered/filter->children","p__35686","vec__35688","v'","clojure.set.difference.cljs$core$IFn$_invoke$arity$2","args__4736__auto__","len__4730__auto__","i__4731__auto__","argseq__4737__auto__","cljs.core/IndexedSeq","lib-draw-graph.clustered/remove-clusters","seq35694","G__35695","cljs.core/next","self__4717__auto__","clstrs-set","p1__35693#","cljs.core/dissoc","lib-draw-graph.clustered/remove-nodes","nodes","g'","clstrs-to-remove","g''"],"sourcesContent":["(ns ^{:doc \"Extending Loom to handle clusters.\"\n      :author \"Jude Payne\"}\n  lib-draw-graph.clustered\n  (:require [loom.graph            :as loom.graph]\n            [loom.attr             :as loom.attr]\n            [loom.alg-generic      :as loom.gen]\n            [clojure.set           :as set]))\n\n\n;; Loom Digraph is a Clojure record\n;; I have gone with the option of assoc'ing into it\n;; rather than extending the type and defining new protocols, for now.\n(defn ->keyword\n  \"Converts to keyword if needed\"\n  [k]\n  (if (keyword? k) k (keyword k)))\n\n\n(defn add-cluster-key\n  [g cluster-on]\n  (assoc-in g [:clusters :key] (->keyword cluster-on)))\n\n\n(defn cluster-key\n  [g]\n  (get-in g [:clusters :key]))\n\n\n(defn clustered?\n  [g]\n  (if (cluster-key g)\n    true\n    false))\n\n\n(defn add-attr-to-cluster\n  [g cluster attr-k attr-v]\n  (assoc-in g [:clusters :attr cluster attr-k] attr-v))\n\n\n\n;; --- Cluster edge graph functionality ------\n\n(defn add-cluster-edge\n  [g src tgt]\n  (update-in g [:clusters :edge-graph]\n             (fn [old tgt]\n               (case old\n                 nil (loom.graph/digraph [src tgt])\n                 (loom.graph/add-edges old [src tgt])))\n             tgt))\n\n\n(defn remove-clusters-from-edge-graph\n  [g clstrs]\n  (update-in g [:clusters :edge-graph]\n             (fn [old clstrs]\n               (apply loom.graph/remove-nodes old clstrs))\n             clstrs))\n\n\n(defn delete-edge-graph\n  [g]\n  (assoc g\n         :clusters\n         (dissoc (-> g :clusters) :edge-graph)))\n\n\n(defn edge-graph\n  [g]\n  (-> g :clusters :edge-graph))\n\n\n;; --- Cluster parent graph functionality ------\n\n(defn add-cluster-parent\n  [g cluster parent]\n  (-> g\n      (assoc-in [:clusters :hierarchy :->parent cluster] parent)\n      (update-in [:clusters :hierarchy :->children parent]\n                 (fn [old]\n                   (if (some? old) (conj old cluster) (conj #{} cluster))))))\n\n\n(defn cluster-parent\n  [g cluster]\n  (get-in g [:clusters :hierarchy :->parent cluster]))\n\n\n(defn cluster-children\n  [g cluster]\n  (get-in g [:clusters :hierarchy :->children cluster]))\n\n\n(defn cluster-graph\n  [g]\n  (-> g :clusters :hierarchy :->children))\n\n\n(defn cluster-siblings\n  [g cluster]\n  (let [parent (cluster-parent g cluster)\n        chdrn (cluster-children g parent)]\n    (remove #{cluster} chdrn)))\n\n\n(defn cluster-descendants\n  \"Returns all clusters inside the cluster recursively.\"\n  [g cluster]\n  (letfn [(descend [clstr acc]\n            (let [children (cluster-children g clstr)]\n              (if (nil? children)\n                (conj acc clstr)\n                (map #(descend % (conj acc clstr)) children))))]\n    (flatten (descend cluster []))))\n\n\n(defn first-cluster-attr\n  \"Gets sub-key attrs for the cluster, or if none, it's parent's attrs\n   and so on.\"\n  [g cluster sub-key]\n  (let [attr (sub-key (get (-> g :clusters :attr) cluster))]\n    (if attr\n      attr\n      (if-let [parent (cluster-parent g cluster)]\n        (first-cluster-attr g parent sub-key)\n        nil))))\n\n\n(defn merged-cluster-attr\n  \"Goes to the ultimate parent of the cluster and back down merging attributes\n  such that the child's attributes overwrite the parent's.\"\n  [g cluster sub-key]\n  (if-let [parent (cluster-parent g cluster)]\n    (merge  (merged-cluster-attr g parent sub-key)\n            (sub-key (get (-> g :clusters :attr) cluster)))\n    (sub-key (get (-> g :clusters :attr) cluster))))\n\n\n(defn cluster->nodes\n  \"Returns the nodes in the current cluster but not in children\n   of the current cluster.\"\n  ([g cluster] (cluster->nodes g (cluster-key g) cluster))\n  ([g cluster-on cluster]\n   (filter\n    #(= cluster (get % (->keyword cluster-on)))\n    (loom.graph/nodes g))))\n\n\n(defn cluster->all-nodes\n  \"Returns all nodes in a cluster, given the :cluster-on key\"\n  ([g cluster] (cluster->all-nodes g (cluster-key g)))\n  ([g cluster-on cluster]\n   (let [k (->keyword cluster-on)]\n     (letfn [(children [clstr acc]\n               (let [chds (cluster-children g clstr)\n                     cur-nodes (cluster->nodes g k clstr)\n                     acc (conj acc cur-nodes)]\n                 (if (some? chds)\n                   (map #(children % acc) chds)\n                   acc)))]\n       (let [res (distinct (flatten (children cluster [])))]\n         (if (empty? res)\n           nil\n           res))))))\n\n\n(defn nodes-by-cluster\n  \"Returns nodes in the graph grouped by cluster.\"\n  ([g] (nodes-by-cluster g (cluster-key g)))\n  ([g cluster-on]\n   (group-by (->keyword cluster-on) (loom.graph/nodes g))))\n\n\n(defn node->clusters\n  \"Returns the set of clusters that the node is in.\"\n  ([g n] (node->clusters g (cluster-key g) n))\n  ([g cluster-on n]\n   (letfn [(ancestor [acc]\n             (if-let [new-ancestor (cluster-parent g (first acc))]\n               (ancestor (cons new-ancestor acc))\n               acc))]\n     (into #{} (ancestor [(get n (->keyword cluster-on))])))))\n\n\n(defn nodes->clusters\n  \"Returns the set of clusters that the nodes are in.\"\n  [g nds]\n  (apply set/union (map #(node->clusters g %) nds)))\n\n\n;; ------------------------------\n\n\n(defn clusters\n  \"Returns the set of all clusters in the graph.\"\n  [g]\n  (nodes->clusters g (loom.graph/nodes g)))\n\n\n(defn ^:private filter->parent\n  [m set-to-remove]\n  (reduce\n   (fn [a [k v]]\n     (if (some set-to-remove #{k v})\n       a\n       (assoc a k v)))\n   {}\n   m))\n\n\n(defn ^:private filter->children\n  [m set-to-remove]\n  (reduce\n   (fn [a [k v]]\n     (if (some #{k} set-to-remove)\n       a\n       (let [v' (set/difference v set-to-remove)]\n         (if (empty? v')\n           a\n           (assoc a k v')))))\n   {}\n   m))\n\n\n(defn remove-clusters\n  \"Removes clusters from the graph.\n   Doesn't touch cluster edgess, so that those can be filtered down (once)\n   after multiple filtering operations.\"\n  [g & clstrs]\n  (let [clstrs-set (into #{} clstrs)]\n    (-> g\n        (update-in [:clusters :attr] #(apply dissoc % clstrs))\n        (update-in [:clusters :hierarchy :->parent] filter->parent clstrs-set)\n        (update-in [:clusters :hierarchy :->children] filter->children clstrs-set))))\n\n\n(defn remove-nodes\n  \"Removes nodes from a clustered graph. Returns a map of {:graph <graph>\n   :clusters <the clusters which remain>}\"\n  [g nodes]\n  (let [clstrs (clusters g)\n        g' (apply loom.graph/remove-nodes g nodes)\n        clstrs-to-remove (set/difference (clusters g) (clusters g'))\n        g'' (apply remove-clusters g' clstrs-to-remove)]\n    g''))\n\n"]}