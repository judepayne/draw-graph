{"version":3,"sources":["kvlt/middleware/util.cljc"],"mappings":"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","names":["var_args","G__35631","kvlt.middleware.util/->content-type","js/Error","t","cljs.core/Keyword","major","or__4185__auto__","cljs.core/namespace","cljs.core/name","charset","G__35640","kvlt.middleware.util.__GT_content_type","kvlt.middleware.util/spec->fn","spec","cljs.core/identity","cljs.core/coll?","vec__35647","cljs.core.nth","p1__35641#","k","f","cljs.core.update","kvlt.middleware.util/clean-req","r","cljs.core.dissoc","kvlt.middleware.util/wrap-before","map__35660","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","cljs.core.get","has","removing","cljs.core/meta","p__35666","map__35667","v","req","G__35672","args__4795__auto__","len__4789__auto__","i__4790__auto__","argseq__4796__auto__","cljs.core/IndexedSeq","kvlt.middleware.util/->mw","p__35677","vec__35678","seq35674","G__35675","cljs.core/first","cljs.core/next","G__35676","self__4776__auto__","helpful-name","before","after","issue!","p__35681","map__35682","trace","G__35684","cljs.core.fnil","cljs.core/conj","cats.core._GT__GT__EQ_","cljs.core.comp","cats.core/return","p1__35673#","G__35685","kvlt.middleware.util/url-decode","p__35691","vec__35692","seq35689","G__35690","encoded","encoding","cljs.core.not_EQ_","taoensso.timbre._log_BANG_","taoensso.timbre/*config*","cljs.core/Delay","js/decodeURIComponent","kvlt.middleware.util/url-encode","p__35700","vec__35701","seq35698","G__35699","unencoded","js/encodeURIComponent","kvlt.middleware.util/url-encode-illegal-characters","path-or-query","clojure.string/replace","kvlt.middleware.util/parse-content-type","s","temp__5733__auto__","m","cljs.core/re-matches","cljs.core.keyword","clojure.string.split","cljs.core.remove","clojure.string/blank?","p1__35704#","cljs.core.map","cljs.core.mapcat","p__35708","vec__35709","clojure.string/lower-case","clojure.string/trim","pattern","kvlt.middleware.util/charset","p__35717","vec__35718","map__35721","seq35715","G__35716","content-type","fallback","G__35723","cljs.core/re-find","cljs.core/second","kvlt.middleware.util/string->base64","x","goog.crypt.base64/encodeString","kvlt.middleware.util/basic-auth","vec__35727","user","pass","cljs.core/map?","kvlt.middleware.util/parse-url","url","js/goog.Uri","temp__5735__auto__","port","G__35733","G__35734","cljs.core/not-empty","G__35735"],"sourcesContent":["(ns ^:no-doc kvlt.middleware.util\n  (:require [kvlt.platform.util :as platform.util]\n            [cats.labs.promise]\n            [clojure.string :as str]\n            [cats.core :as m]\n            [taoensso.timbre :as log]\n            #? (:cljs [goog.crypt.base64 :as base64]))\n  #? (:clj\n      (:import [java.net URL URLEncoder URLDecoder]\n               [org.apache.commons.codec.binary Base64])\n      :cljs\n      (:require-macros [kvlt.middleware.util]))\n  #? (:cljs (:import [goog.Uri])))\n\n(defn ->content-type\n  ([t]\n   (if (keyword? t)\n     (let [major (or (namespace t) :application)]\n       (str (name major) \"/\" (name t)))\n     t))\n  ([t charset]\n   (cond-> (->content-type t) charset (str \"; charset=\" charset))))\n\n(defn spec->fn [spec]\n  (cond (nil?  spec) identity\n        (coll? spec) (let [[k f] spec]\n                       #(update % k f))\n        :else spec))\n\n(defn- clean-req [r]\n  (dissoc r\n          :kvlt.middleware/request\n          :kvlt.middleware/response\n          :kvlt/trace))\n\n(defn wrap-before [f]\n  (let [{:keys [has removing]} (meta f)\n        f (if has\n            (fn [{v has :as req}]\n              (cond-> req\n                v f))\n            f)]\n    (if removing\n      (fn [req]\n        (dissoc (f req) removing))\n      f)))\n\n(defn ->mw [helpful-name before & [after]]\n  (let [after  (spec->fn after)\n        before (-> before spec->fn wrap-before)]\n    (fn [issue!]\n      (fn [{:keys [kvlt/trace] :as req}]\n        (let [req (before req)\n              req (cond-> req\n                    trace (update :kvlt.middleware/request\n                                  (fnil conj [])\n                                  [helpful-name (clean-req req)]))]\n          (m/>>=\n           (issue! req)\n           (comp m/return after)\n           (comp m/return\n                 #(cond-> %\n                    trace\n                    (update :kvlt.middleware/response\n                            (fnil conj [])\n                            [helpful-name (clean-req req)])))))))))\n\n#? (:clj\n    (defmacro defmw [varname doc before & [after]]\n      `(def ~varname ~doc\n         (->mw ~(keyword varname) ~before ~after))))\n\n;; More or less all from clj-http, with portability adjustments\n\n(defn url-decode [encoded & [encoding]]\n  (let [encoding (or encoding \"UTF-8\")]\n    #? (:clj\n        (URLDecoder/decode encoded encoding)\n        :cljs\n        (do\n          (when (not= \"UTF-8\" encoding)\n            (log/warn \"url-decode ignoring encoding\" encoding))\n          (js/decodeURIComponent encoded)))))\n\n(defn url-encode [unencoded & [encoding]]\n  (let [encoding (or encoding \"UTF-8\")]\n    #? (:clj\n        (URLEncoder/encode unencoded encoding)\n        :cljs\n        (do\n          (when (not= \"UTF-8\" encoding)\n            (log/warn \"url-encode ignoring encoding\" encoding))\n          (js/encodeURIComponent unencoded)))))\n\n(defn url-encode-illegal-characters\n  \"Takes a raw url path or query and url-encodes any illegal characters.\n  Minimizes ambiguity by encoding space to %20.\"\n  [path-or-query]\n  (when path-or-query\n    (-> path-or-query\n        (str/replace \" \" \"%20\")\n        (str/replace #\"[^a-zA-Z0-9\\.\\-\\_\\~\\!\\$\\&\\'\\(\\)\\*\\+\\,\\;\\=\\:\\@\\/\\%\\?]\"\n                     url-encode))))\n\n(defn parse-content-type\n  \"Parse `s` as an RFC 2616 media type.\"\n  [s]\n  (if-let [m (re-matches #\"\\s*(([^/]+)/([^ ;]+))\\s*(\\s*;.*)?\" (str s))]\n    {:content-type (keyword (nth m 1))\n     :content-type-params\n     (->> (str/split (str (nth m 4)) #\"\\s*;\\s*\")\n          (identity)\n          (remove str/blank?)\n          (map #(str/split % #\"=\"))\n          (mapcat (fn [[k v]] [(keyword (str/lower-case k)) (str/trim v)]))\n          (apply hash-map))}))\n\n(let [pattern #\"(?i)charset\\s*=\\s*([^\\s]+)\"]\n  (defn charset\n    [content-type & [{:keys [fallback]}]]\n    (let [charset (some->> content-type name (re-find pattern) second)]\n      (or charset fallback \"UTF-8\"))))\n\n(defn string->base64 [x]\n  #? (:clj\n      (-> x (.getBytes \"UTF-8\") Base64/encodeBase64 (String. \"UTF-8\"))\n      :cljs\n      (base64/encodeString x)))\n\n(defn basic-auth [v]\n  (let [[user pass]\n        (if (map? v)\n          [(v :username) (v :password)]\n          v)]\n    (str \"Basic \" (string->base64 (str user \":\" pass)))))\n\n(defn ^:no-doc parse-url [url]\n  (let [url #? (:clj (java.net.URL. url) :cljs (goog.Uri. url))]\n    {:scheme       (-> url #? (:clj .getProtocol :cljs .getScheme) keyword)\n     :server-name  (.. url #? (:clj getHost :cljs getDomain))\n     :server-port  (when-let [port (.getPort url)]\n                     (when (pos? port) port))\n     :uri          (some-> url .getPath  url-encode-illegal-characters)\n     :query-string (some-> url .getQuery not-empty url-encode-illegal-characters)\n     :user-info    (some-> url .getUserInfo not-empty url-decode)}))\n"]}