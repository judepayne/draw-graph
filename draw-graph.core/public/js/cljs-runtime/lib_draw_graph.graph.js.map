{"version":3,"sources":["lib_draw_graph/graph.cljc"],"mappings":"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","names":["lib-draw-graph.graph/color-channels","rgb","lib-draw-graph.graph/hex","n","var_args","args__4736__auto__","len__4730__auto__","i__4731__auto__","argseq__4737__auto__","cljs.core/IndexedSeq","lib-draw-graph.graph/str->rgb","p__35957","map__35958","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","cljs.core/hash-map","cljs.core.get.cljs$core$IFn$_invoke$arity$3","seq35954","G__35955","cljs.core/first","cljs.core/next","self__4717__auto__","s","blend-with","h","cljs.core/hash","rgb-blend","red","green","blue","lib-draw-graph.graph/edge-invisible?","g","n1","n2","style","loom.attr.attrs.cljs$core$IFn$_invoke$arity$3","and__4120__auto__","p1__35962#","cljs.core/some","cljs.core._EQ_.cljs$core$IFn$_invoke$arity$2","clojure.string.split.cljs$core$IFn$_invoke$arity$2","lib-draw-graph.graph/leaf?","succs","loom.graph/successors*","visible-succs","p1__35967#","cljs.core.filter.cljs$core$IFn$_invoke$arity$2","cljs.core/not","cljs.core/empty?","lib-draw-graph.graph/root?","opts","loom.graph/predecessors*","lib-draw-graph.graph/successors","p1__35972#","lib-draw-graph.graph/fff","nested","cljs.core/ffirst","lib-draw-graph.graph/group-map","seq35980","G__35981","m","grps","cljs.core.reduce.cljs$core$IFn$_invoke$arity$3","acc","cur","cljs.core.assoc.cljs$core$IFn$_invoke$arity$3","cljs.core/select-keys","cljs.core/rest","lib-draw-graph.graph/default-options","lib-draw-graph.graph/shape","lib-draw-graph.graph/fillcolor","color-key","temp__5718__auto__","ck","cl","lib-draw-graph.clustered/cluster-key","loom.graph/nodes","fexpr__36014","cljs.core.keyword.cljs$core$IFn$_invoke$arity$1","lib-draw-graph.graph/first-label","lbls","metadata","lbl","p1__36015#","v","fexpr__36016","lib-draw-graph.graph/composite-label","cljs.core/str","cljs.core.interpose.cljs$core$IFn$_invoke$arity$2","cljs.core.map.cljs$core$IFn$_invoke$arity$2","x","cljs.core.get.cljs$core$IFn$_invoke$arity$2","lib-draw-graph.graph/node-label","clojure.string/includes?","lib-draw-graph.graph/node-tooltip","temp__5720__auto__","tt","ks","cljs.core/keyword","a","c","cljs.core.conj.cljs$core$IFn$_invoke$arity$2","cljs.core/name","lib-draw-graph.graph/node-url","url","lib-draw-graph.graph/doub-slash-n","clojure.string/replace","lib-draw-graph.graph/node-descriptor","cljs.core.merge.cljs$core$IFn$_invoke$arity$variadic","cljs.core.assoc.cljs$core$IFn$_invoke$arity$variadic","cljs.core/map?","loom.attr.attrs.cljs$core$IFn$_invoke$arity$2","cljs.core.dissoc.cljs$core$IFn$_invoke$arity$2","lib-draw-graph.graph/constrained?","loom.attr.attr.cljs$core$IFn$_invoke$arity$4","lib-draw-graph.graph/maybe-show-constraint","show","lib-draw-graph.graph/edge-label","lib-draw-graph.graph/constraints","lib-draw-graph.graph/edge-descriptor","lib-draw-graph.graph/structure-opts","lib_draw_graph.graph.group_map.cljs$core$IFn$_invoke$arity$variadic","lib-draw-graph.graph/cluster-args","fexpr__36049","cljs.core.partial.cljs$core$IFn$_invoke$arity$3","lib-draw-graph.clustered/node->clusters","lib-draw-graph.clustered/merged-cluster-attr","y","lib-draw-graph.clustered/first-cluster-attr","cljs.core.partial.cljs$core$IFn$_invoke$arity$2","lib-draw-graph.clustered/cluster-parent","lib-draw-graph.graph/get-rhizome-args","opts*","lib_draw_graph.util.deep_merge.cljs$core$IFn$_invoke$arity$variadic","lib-draw-graph.graph/graph->dot","succs-fn","rhi-args","cljs.core.apply.cljs$core$IFn$_invoke$arity$4","rhizome.dot/graph->dot","cljs.core/concat","lib-draw-graph.graph/loomgraph->dot","p1__36052#","lib-draw-graph.graph/process-graph"],"sourcesContent":["(ns ^{:doc \"Defines functions for creating and Loom digraph from a csv file of edges,\n           displaying a digraph with flexible options and for providing a set of\n           analytics about a digraph. Note that the definition of structure-opts\n           needs to be updated when new graphviz options are added.\"\n      :author \"Jude Payne\"}\n    lib-draw-graph.graph\n    (:require [rhizome.dot                     :as rhidot]\n              [loom.graph                      :as loom.graph]\n              [loom.attr                       :as loom.attr]\n              [clojure.string                  :as str]\n              [lib-draw-graph.clustered        :as clstr]\n              [lib-draw-graph.util             :as util]\n              #?@(:cljs [[goog.string :as gstring]])\n              #?@(:cljs [[goog.string.format]])))\n\n\n;; ---------------------\n;; Utility graph functions\n\n(defn ^:private color-channels\n  \"Returns a map of rgb values from a 24-bit number.\"\n  [rgb]\n  {:r (bit-shift-right (bit-and rgb 0xFF0000) 16)\n   :g (bit-shift-right (bit-and rgb 0x00FF00) 8)\n   :b (bit-and rgb 0x0000FF)})\n\n\n(defn ^:private hex\n  \"Convert an unsigned integer to a hex string representation.\"\n  [n]\n  #?(:clj (format \"%x\" n)\n     :cljs (.toString n 16)))\n\n\n(defn ^:private str->rgb\n  \"Converts a string to an rgb color value, blending with blend-with.\"\n  [s & {:keys [blend-with] :or {blend-with 0xBBFFBB}}]\n  (let [h (bit-shift-right (hash s) 8) ;;shift to 24-bit\n        rgb (color-channels h)\n        rgb-blend (color-channels blend-with)\n        red   (bit-shift-right (+ (:r rgb) (:r rgb-blend)) 1)\n        green (bit-shift-right (+ (:g rgb) (:g rgb-blend)) 1)\n        blue  (bit-shift-right (+ (:b rgb) (:b rgb-blend)) 1)]\n    (str \"#\" (hex red) (hex green) (hex blue))))\n\n\n(defn edge-invisible?\n  [g n1 n2]\n  (let [style (:style (loom.attr/attrs g n1 n2))]\n    (and style (some #(= \"invis\" %) (str/split style #\",\")))))\n\n\n(defn leaf? [g n]\n  (let [succs (loom.graph/successors* g n)\n        visible-succs (filter #(not (edge-invisible? g n %)) succs)]\n    (empty? visible-succs)))\n\n\n(defn root? [g opts n]\n  (and\n   (-> opts :env :show-roots?)\n   (empty? (loom.graph/predecessors* g n))))\n\n\n(defn successors\n  \"Takes into account invisible edges\"\n  [g n]\n  (let [succs (loom.graph/successors* g n)]\n    (filter #(not (edge-invisible? g n %)) succs)))\n\n\n(defn ^:private fff [nested] (first (ffirst nested)))\n\n\n(defn group-map\n  \"Groups m by the first in each of grps, selects the rest keys into\n  the new submap and continues through the rest of the groups.\n  e.g. (group-map {:graph-a 1 :graph-b 2 :node-c 4 :edge-a 5}\n                   [:graph :graph-a :graph-b] [:node :node-c])\n  => {:graph {:graph-a 1, :graph-b 2}, :node {:edge-a 5}}\"\n  [m & grps]\n  (reduce \n   (fn [acc cur]\n     (assoc acc (first cur) (select-keys m (rest cur))))\n   {}\n   grps))\n\n\n;; ---------------------\n;; Config for graph display, using Rhizome library\n\n\n(def default-options\n  {:graph\n   {:dpi 72\n    :layout \"dot\"\n    :splines \"lines\"\n    :overlap \"prism\"\n    :pad 0.2\n    :rankdir \"LR\"\n   ; :size \"4,4!\"\n   ; :ratio \"1.0\"\n    }\n   :node\n   {:style \"filled\"\n    :fontsize 10\n    :fixedsize \"true\"\n    :shape \"ellipse\"\n    :margin \"0.1\"}\n   :env\n   {:show-roots?  false\n   }})\n\n;; node functions\n\n(defn shape\n  \"Returns the shape of node n in g given options\"\n  [g opts n]\n  (cond\n    (root? g opts n) \"tripleoctagon\"\n    :else (-> opts :node :shape)))\n\n\n(defn fillcolor\n  \"Return the fillcolor for node n in g given an options\"\n  [g opts n]\n  ;; if cluster-on, use that key to generate node colours\n  ;; otherwise grab any node and use the first key in it\n  (let [color-key (if-let [ck (-> opts :env :color-on)]\n                    ck\n                    (if-let [cl (clstr/cluster-key g)] \n                      cl\n                      (fff (loom.graph/nodes g))))]\n    (str->rgb ((keyword color-key) n))))\n\n\n(defn first-label\n  \"Gets the first valid label from the metadata, which can be a node or edge metadata.\"\n  [lbls metadata]\n  (let [lbls (str/split lbls #\"/\")\n        lbl (some #(let [v ((keyword %) metadata)]\n                     (if (= \"\" v) false v)) lbls)]\n    (if (nil? lbl) \"\" lbl)))\n\n\n(defn composite-label\n  \"Gets the composite label from the metadata, which can be a node or edge metadata.\"\n  [lbls metadata]\n  (let [lbls (str/split lbls #\"&\")\n        lbl (apply str\n                   (interpose \"\\n\"\n                              (map\n                               (fn [x] (get metadata (keyword x)))\n                               lbls)))]\n    (if (nil? lbl) \"\" lbl)))\n\n\n(defn node-label\n  \"Returns the label for the node n in g given options.\"\n  [g opts n]\n  (cond\n    (and (leaf? g n) (-> opts :env :hide-leaves?)) \"\"\n    :else (if-let [lbls (-> opts :node :label)]\n            (if (str/includes? lbls \"/\")\n              (first-label lbls n)\n              (composite-label lbls n))\n            \"\")))\n\n\n(defn node-tooltip\n  \"Returns the tooltip for the node n in g given options.\"\n  [g opts n]\n  (when-let [tt (-> opts :node :tooltip)]\n    (let [ks (map keyword (str/split tt #\"&\"))\n          tt (apply str (interpose\n                  \"\\n\"\n                  (reduce\n                   (fn [a c]\n                     (conj a (str (name c) \": \"(get n c))))\n                   []\n                   ks)))]\n      tt)))\n\n\n(defn node-url\n  \"Returns the url for the node n in g given options.\"\n  [g opts n]\n  (when-let [url (-> opts :node :url)]\n    (get n (keyword url))))\n\n\n;; cljs requires \\n to be supplied as \\\\n otherwise will split line\n;; whereas clj does not & will not. Use cljs fomrat but last minute\n;; replace for when run from clojure\n(defn doub-slash-n\n  [s]\n  (if (nil? s) nil\n      (str/replace s #\"\\\\\\\\n\" \"\\n\")))\n\n\n(defn ^:private node-descriptor\n  \"Returns map of attributes for the node from *display-conf*.\"\n  [g opts n]\n  (merge\n   (:node opts) ;;static attrs\n   ;; attrs result from functions..\n   (-> {}\n       (assoc :shape (shape g opts n))\n       (assoc :label (doub-slash-n (node-label g opts n)))\n       (assoc :fillcolor (fillcolor g opts n))\n       (assoc :tooltip  (node-tooltip g opts n))\n       (assoc :URL (node-url g opts n) :target \"_blank\"))\n   ;;per node attrs supplied by user\n   (if (and (root? g opts n) (map? (loom.attr/attrs g n)))\n     (dissoc (loom.attr/attrs g n) :shape)\n     (loom.attr/attrs g n))))\n\n\n(defn ^:private constrained? [g n1 n2]\n  (loom.attr/attr g n1 n2 :constraint))\n\n\n(defn ^:private maybe-show-constraint [g opts n1 n2]\n  (let [show (-> opts :env :show-constraints?)]\n    (when (and show (constrained? g n1 n2))\n      {:style \"\" :color \"deeppink3\" :penwidth 4})))\n\n\n(defn edge-label\n  \"Returns the label for the edge n1 n2 in g given options.\"\n  [g opts n1 n2]\n  (when-let [lbls (-> opts :edge :edge-label)]\n    (let [metadata (loom.attr/attr g n1 n2 :meta)]\n      (if (str/includes? lbls \"/\")\n        (first-label lbls metadata)\n        (composite-label lbls metadata)))))\n\n\n(defn constraints\n  [g opts n1 n2]\n  (if (-> opts :env :constraint)\n    {:constraint true}\n    {:constraint false}))\n\n\n(defn ^:private edge-descriptor\n  \"Return map of attributes for the edge from *display-conf*\"\n  [g opts n1 n2]\n  (merge\n   (if (-> opts :edge :edge-label)\n     {:xlabel (doub-slash-n (edge-label g opts n1 n2)) :forcelabels true}\n     nil)\n   (constraints g opts n1 n2)\n   ;; per edge attrs supplied by user\n   (dissoc (loom.attr/attrs g n1 n2) :meta)\n   (maybe-show-constraint g opts n1 n2)))\n\n\n;; NEEDS TO CHANGE WHEN NEW OPTS ADDED\n(defn structure-opts\n  \"structures the incoming opts map the same as default-options\"\n  [opts]\n  (group-map opts\n             [:graph :dpi :layout :pad :splines :sep :ranksep\n              :scale :overlap :nodesep :rankdir :concentrate :ratio]\n             [:node :shape :label :fontsize :style :fixedsize :tooltip :url]\n             [:env :hide-leaves? :show-roots? :color-on :constraint :show-constraints?]\n             [:edge :edge-label]))\n\n\n(defn- cluster-args\n  [g]\n  {\n   :node->clusters\n   (fn [n] ((partial clstr/node->clusters g (clstr/cluster-key g)) n))\n\n   :cluster->descriptor\n   (fn [n] (merge {:label n}\n                  (let [x (clstr/merged-cluster-attr g n :style)\n                        y (if (nil? x) {} x)]\n                    y)))\n\n   :cluster->ranks\n   (fn [n]\n     (clstr/first-cluster-attr g n :fix-ranks))\n\n   :cluster->parent\n   (partial clstr/cluster-parent g)   \n   })\n\n\n(defn ^:private get-rhizome-args\n  \"Returns the rhizome config (options) for a graph.\"\n  [g opts]\n  (let [opts* (util/deep-merge default-options (structure-opts opts))]\n    (merge\n     {\n      :options (:graph opts*) \n\n      :node->descriptor (partial node-descriptor g opts*)\n\n      :edge->descriptor (partial edge-descriptor g opts*)}\n\n     ;; merge in cluster argument when g is clustered\n     (when (clstr/cluster-key g)\n       (cluster-args g)))))\n\n\n;; -------------------------------------------------------------\n;; ****** Functions to convert Loom graphs using Rhizome  ******\n\n(defn graph->dot\n  \"Returns an dot representation of a graph.\"\n  [ks succs-fn rhi-args]\n  (-> (apply\n       rhidot/graph->dot ks succs-fn\n       (apply concat rhi-args))))\n\n\n(defn ^:private loomgraph->dot\n  \"converts loom graph to dot using rhizome\"\n  [g rhi-args]\n  (let [ks       (loom.graph/nodes g)\n        succs-fn #(loom.graph/successors* g %)]\n    (graph->dot ks succs-fn rhi-args)))\n\n\n;;--------------------\n;; public functions for producing dot\n\n(defn process-graph\n  \"Converts (Loom) graph to either a graph or an svg\"\n  [g opts]\n  (loomgraph->dot g (get-rhizome-args g opts)))\n\n"]}