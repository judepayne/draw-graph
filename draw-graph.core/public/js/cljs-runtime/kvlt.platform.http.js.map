{"version":3,"sources":["kvlt/platform/http.cljs"],"mappings":"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","names":["kvlt.platform.http/->response","req","m","cljs.core.vary_meta.cljs$core$IFn$_invoke$arity$4","cljs.core/assoc","kvlt.platform.http/error->map","e","code","or__4131__auto__","cljs.core.keyword.cljs$core$IFn$_invoke$arity$1","p__47056","map__47057","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","cljs.core/hash-map","cljs.core.get.cljs$core$IFn$_invoke$arity$2","kvlt.platform.http/compose-url","query-string","server-port","cljs.core/name","G__47065","G__47066","G__47073","p__47078","map__47079","kvlt.platform.http/req->node","body","timeout","insecure?","G__47085","clojure.string/upper-case","G__47086","cljs.core.assoc.cljs$core$IFn$_invoke$arity$3","kvlt.platform.http/maybe-encode","buffer","as","headers","cljs.core._EQ_.cljs$core$IFn$_invoke$arity$2","cs","kvlt.middleware.util/charset","cljs.core/*target*","request!","js/require","kvlt.platform.http/request-node!","promesa.core/promise","resolve","_","respond","p1__47096#","cljs.core.comp.cljs$core$IFn$_invoke$arity$2","G__47097","G__47098","cljs.core/clj->js","error","node-resp","G__47102","cljs.core.js__GT_clj.cljs$core$IFn$_invoke$arity$variadic","resp","G__47106","taoensso.timbre._log_BANG_.cljs$core$IFn$_invoke$arity$10","taoensso.timbre/*config*","cljs.core/Delay","kvlt.util/pprint-str","kvlt.platform.http/request!","kvlt.platform.xhr/request!"],"sourcesContent":["(ns ^:no-doc kvlt.platform.http\n  (:require [cljs.core.async :as async]\n            [taoensso.timbre :as log]\n            [clojure.string :as str]\n            [kvlt.util :as util]\n            [promesa.core :as p]\n            [kvlt.platform.xhr :as xhr]\n            [kvlt.middleware.util :refer [charset]]))\n(defn ->response [req m]\n  (vary-meta m assoc :kvlt/request req))\n\n(defn error->map [e]\n  (let [code (or (keyword (.. e -code)) :unknown)]\n    {:type    code\n     :error   code\n     :message (.. e -message)\n     :status  0}))\n\n(defn- compose-url [{:keys [query-string server-port] :as req}]\n  (str (name (req :scheme))\n       \"://\"\n       (req :server-name)\n       (when server-port\n         (str \":\" server-port))\n       (req :uri)\n       (when query-string\n         (str \"?\" query-string))))\n\n(defn req->node [{:keys [body kvlt.platform/timeout kvlt.platform/insecure?] :as req}]\n  (cond->\n      {:uri      (compose-url req)\n       :method   (-> req :request-method name str/upper-case)\n       :headers  (req :headers)\n       :encoding nil\n       :gzip     true}\n    body      (assoc :body body)\n    timeout   (assoc :timeout timeout)\n    insecure? (assoc :rejectUnauthorized false)))\n\n(defn- maybe-encode [buffer as headers]\n  (if (= as :byte-array)\n    buffer\n    (let [cs (-> headers :content-type charset)]\n      (.toString buffer cs))))\n\n(when (= *target* \"nodejs\")\n  (let [request! (js/require \"request\")]\n    (defn request-node! [req]\n      (p/promise\n       (fn [resolve _]\n         (let [respond (comp resolve #(->response req %))]\n           (request!\n            (clj->js (req->node req))\n            (fn [error node-resp buffer]\n              (if error\n                (respond (error->map error))\n                (let [headers (js->clj (.. node-resp -headers) :keywordize-keys true)\n                      resp    {:headers headers\n                               :status  (.. node-resp -statusCode)\n                               :body    (maybe-encode buffer (req :as) headers)}]\n                  (log/debug \"Received response\\n\" (util/pprint-str resp))\n                  (respond resp)))))))))))\n\n(defn request! [req]\n  (log/debug \"Issuing request\\n\" (util/pprint-str req))\n  (if (= *target* \"nodejs\")\n    (request-node! req)\n    (xhr/request! req)))\n"]}